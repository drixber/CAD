name: Release Windows

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: MSVC Dev Cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Disable Windows Python store aliases
        shell: powershell
        run: |
          Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python.exe" -ErrorAction SilentlyContinue
          Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python3.exe" -ErrorAction SilentlyContinue

      - name: Setup Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.6.0"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2022_64"

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DAPP_VERSION=${{ github.ref_name }}

      - name: Build
        run: cmake --build build --config Release

      - name: Package
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null

          $exeCandidates = Get-ChildItem -Path build -Recurse -Filter *.exe -File
          if (-not $exeCandidates) {
            throw "No executable found under build/"
          }

          $preferred = $exeCandidates | Where-Object { $_.Name -ieq "CAD.exe" } | Select-Object -First 1
          $nonTest = $exeCandidates | Where-Object { $_.Name -notmatch "(?i)test" } | Select-Object -First 1
          $exe = if ($preferred) { $preferred } elseif ($nonTest) { $nonTest } else { $exeCandidates | Select-Object -First 1 }
          Write-Host ("Selected EXE: " + $exe.FullName)

          Copy-Item -Path $exe.FullName -Destination dist
          $exePath = Join-Path dist $exe.Name

          $windeployqt = Get-Command windeployqt -ErrorAction SilentlyContinue
          if ($windeployqt) {
            try {
              & $windeployqt $exePath
            } catch {
              Write-Host "windeployqt failed: $($_.Exception.Message)"
            }
          } else {
            Write-Host "windeployqt not found in PATH"
          }

          Compress-Archive -Path dist\* -DestinationPath app-windows.zip -Force

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: app-windows.zip
