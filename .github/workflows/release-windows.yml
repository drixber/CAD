name: Release Windows

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest
    env:
      WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
      WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: MSVC Dev Cmd
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Ninja
        uses: seanmiddleditch/gha-setup-ninja@v5

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Disable Windows Python store aliases
        shell: powershell
        run: |
          Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python.exe" -ErrorAction SilentlyContinue
          Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python3.exe" -ErrorAction SilentlyContinue

      - name: Setup Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: "6.5.3"
          host: "windows"
          target: "desktop"
          arch: "win64_msvc2019_64"
          cache: true

      - name: Clean build directory
        shell: cmd
        run: |
          if exist build rmdir /s /q build

      - name: Configure
        run: cmake -S . -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DAPP_VERSION=${{ github.ref_name }} -DCAD_USE_QT=ON -DCAD_BUILD_TESTS=OFF -DQt6_DIR="%Qt6_DIR%" -DCMAKE_PREFIX_PATH="%Qt6_DIR%"

      - name: Build
        run: cmake --build build --config Release

      - name: Install NSIS
        shell: powershell
        run: |
          choco install nsis -y

      - name: Package
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path dist | Out-Null
          New-Item -ItemType Directory -Force -Path "build\Release" | Out-Null

          $exeCandidates = Get-ChildItem -Path build -Recurse -Filter *.exe -File
          if (-not $exeCandidates) {
            throw "No executable found under build/"
          }

          $preferred = $exeCandidates | Where-Object { $_.Name -ieq "CAD.exe" } | Select-Object -First 1
          $nonTest = $exeCandidates | Where-Object { $_.Name -notmatch "(?i)test" } | Select-Object -First 1
          $exe = if ($preferred) { $preferred } elseif ($nonTest) { $nonTest } else { $exeCandidates | Select-Object -First 1 }
          Write-Host ("Selected EXE: " + $exe.FullName)

          Copy-Item -Path $exe.FullName -Destination "build\Release\cad_desktop.exe" -Force
          Copy-Item -Path $exe.FullName -Destination dist -Force
          $exePath = "build\Release\cad_desktop.exe"

          if (-not $env:Qt6_DIR) {
            throw "Qt6_DIR not set by install-qt-action."
          }
          $qtBin = Resolve-Path (Join-Path $env:Qt6_DIR "..\\..\\..\\bin")
          $windeployqt = Join-Path $qtBin "windeployqt.exe"
          if (-not (Test-Path $windeployqt)) {
            throw "windeployqt not found: $windeployqt"
          }
          & $windeployqt $exePath

          # Include deployed Qt files in ZIP
          Copy-Item -Path "build\Release\*" -Destination dist -Recurse -Force

          $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
          if (-not (Test-Path $nsisPath)) {
            $nsisPath = "C:\Program Files\NSIS\makensis.exe"
          }
          if (-not (Test-Path $nsisPath)) {
            throw "NSIS not found at $nsisPath"
          }
          & $nsisPath installer\hydracad.nsi
          if ($LASTEXITCODE -ne 0) {
            throw "NSIS build failed with exit code $LASTEXITCODE"
          }
          if (Test-Path "installer\HydraCADSetup.exe") {
            Copy-Item "installer\HydraCADSetup.exe" -Destination dist -Force
          } else {
            throw "Installer not found at installer\HydraCADSetup.exe"
          }

          Compress-Archive -Path dist\* -DestinationPath app-windows.zip -Force

      - name: Code Sign (optional)
        if: ${{ env.WINDOWS_PFX_BASE64 != '' }}
        shell: powershell
        env:
          WINDOWS_PFX_BASE64: ${{ env.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ env.WINDOWS_PFX_PASSWORD }}
        run: |
          $pfxPath = "$env:RUNNER_TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($pfxPath, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe | Select-Object -First 1
          if (-not $signtool) { throw "signtool.exe not found" }
          & $signtool.FullName sign /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 "dist\cad_desktop.exe"
          & $signtool.FullName sign /f $pfxPath /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 "dist\HydraCADSetup.exe"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v2
        with:
          files: app-windows.zip
