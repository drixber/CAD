name: Create Release with Installer

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v2.0.0)'
        required: true
        type: string

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v2
      with:
        cmake-version: '3.26'
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Disable Windows Python store aliases
      shell: powershell
      run: |
        Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python.exe" -ErrorAction SilentlyContinue
        Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python3.exe" -ErrorAction SilentlyContinue
    
    - name: Setup Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '6.6.0'
        arch: 'win64_msvc2022_64'
    
    - name: Install NSIS
      run: |
        choco install nsis -y
      continue-on-error: true
    
    - name: Configure CMake
      run: |
        $QtDir = if ($env:Qt6_DIR) { $env:Qt6_DIR } else { "$env:RUNNER_TEMP\Qt\6.6.0\msvc2022_64\lib\cmake\Qt6" }
        Write-Host "Using Qt6_DIR: $QtDir"
        cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
          -DCAD_USE_QT=ON `
          -DCAD_BUILD_TESTS=OFF `
          -DCMAKE_BUILD_TYPE=Release `
          -DQt6_DIR="$QtDir" `
          -DCMAKE_PREFIX_PATH="$QtDir"
    
    - name: Build Application
      run: |
        cmake --build build --config Release --parallel
    
    - name: Extract Version
      id: version
      run: |
        if ("${{ github.ref_type }}" -eq "tag") {
          $version = "${{ github.ref_name }}" -replace '^v', ''
        } else {
          $version = "${{ github.event.inputs.version }}" -replace '^v', ''
        }
        if ([string]::IsNullOrEmpty($version)) {
          $version = "2.0.0"
        }
        echo "version=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Release version: $version"
    
    - name: Copy DLLs
      run: |
        $qtDir = if ($env:Qt6_DIR) { $env:Qt6_DIR } else { "$env:RUNNER_TEMP\Qt\6.5.0\msvc2022_64\lib\cmake\Qt6" }
        Write-Host "Qt6_DIR: $qtDir"
        if (Test-Path "$qtDir\..\..\bin") {
          $binPath = Resolve-Path "$qtDir\..\..\bin"
          Write-Host "Copying DLLs from: $binPath"
          Copy-Item "$binPath\*.dll" -Destination "build\Release\" -Force -ErrorAction SilentlyContinue
        } else {
          Write-Host "Qt bin directory not found, skipping DLL copy"
        }
      continue-on-error: true
    
    - name: Create Installer
      run: |
        $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
        if (-not (Test-Path $nsisPath)) {
          $nsisPath = "C:\Program Files\NSIS\makensis.exe"
        }
        if (-not (Test-Path $nsisPath)) {
          Write-Host "Installing NSIS via Chocolatey..."
          choco install nsis -y --no-progress
          Start-Sleep -Seconds 15
          $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
        }
        
        if (Test-Path $nsisPath) {
          Write-Host "Building installer with NSIS: $nsisPath"
          $version = "${{ steps.version.outputs.version }}"
          $projectRoot = $PWD
          & $nsisPath /DINSTALLER_VERSION="$version" /DPROJECT_ROOT="$projectRoot" installer\hydracad.nsi
          if ($LASTEXITCODE -ne 0) {
            Write-Error "NSIS build failed with exit code $LASTEXITCODE"
            exit 1
          }
        } else {
          Write-Error "NSIS not found after installation attempt"
          exit 1
        }
    
    - name: Verify Installer
      run: |
        Start-Sleep -Seconds 2
        if (Test-Path "installer\HydraCADSetup.exe") {
          $file = Get-Item "installer\HydraCADSetup.exe"
          Write-Host "Installer created successfully: $($file.Length) bytes"
        } else {
          Write-Error "Installer not found after build!"
          exit 1
        }
    
    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: HydraCAD-Windows-Installer
        path: installer/HydraCADSetup.exe
        retention-days: 7

  build-linux:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake \
          qt6-base-dev qt6-tools-dev qt6-tools-dev-tools \
          libqt6core6 libqt6gui6 libqt6widgets6 libqt6opengl6-dev \
          file patchelf wget
    
    - name: Configure CMake
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCAD_USE_QT=ON -DCAD_BUILD_TESTS=OFF \
          -DCMAKE_INSTALL_PREFIX=/usr -DQt6_DIR=/usr/lib/x86_64-linux-gnu/cmake/Qt6
    
    - name: Build Application
      run: |
        cmake --build build --parallel
    
    - name: Extract Version
      id: version
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          version="${{ github.ref_name }}"
        else
          version="${{ github.event.inputs.version }}"
        fi
        version=$(echo "$version" | sed 's/^v//')
        if [ -z "$version" ]; then
          version="2.0.0"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Release version: $version"
    
    - name: Install to AppDir
      run: |
        mkdir -p AppDir/usr
        cmake --install build --prefix AppDir/usr
    
    - name: Create AppImage
      run: |
        wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage -O appimagetool
        chmod +x appimagetool
        
        # Ensure executable exists
        if [ ! -f build/cad_desktop ]; then
          echo "Error: cad_desktop not found!"
          exit 1
        fi
        
        # Create AppDir structure
        mkdir -p AppDir/usr/bin AppDir/usr/lib AppDir/usr/share/applications
        
        # Copy executable
        cp build/cad_desktop AppDir/usr/bin/
        chmod +x AppDir/usr/bin/cad_desktop
        
        # Deploy Qt libraries using Qt's deployment tool
        export QTDIR=/usr
        export PATH=$QTDIR/bin:$PATH
        if command -v qt6-deploy &> /dev/null; then
          qt6-deploy AppDir/usr/bin/cad_desktop
        else
          # Fallback: Manual Qt library copy
          export LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH
          ldd build/cad_desktop | grep "libQt" | awk '{print $3}' | while read lib; do
            if [ -f "$lib" ]; then
              cp "$lib" AppDir/usr/lib/ 2>/dev/null || true
            fi
          done
        fi
        
        # Create desktop file
        cat > AppDir/usr/share/applications/hydracad.desktop << 'EOF'
        [Desktop Entry]
        Type=Application
        Name=Hydra CAD
        Comment=Professional CAD Application
        Exec=cad_desktop
        Icon=hydracad
        Categories=Graphics;CAD;
        Terminal=false
        EOF
        
        # Create AppRun
        cat > AppDir/AppRun << 'EOF'
        #!/bin/sh
        HERE="$(dirname "$(readlink -f "${0}")")"
        export LD_LIBRARY_PATH="${HERE}/usr/lib:${LD_LIBRARY_PATH}"
        export QT_PLUGIN_PATH="${HERE}/usr/lib/qt6/plugins"
        exec "${HERE}/usr/bin/cad_desktop" "$@"
        EOF
        chmod +x AppDir/AppRun
        
        # Create AppImage
        VERSION="${{ steps.version.outputs.version }}"
        ./appimagetool AppDir HydraCAD-${VERSION}-x86_64.AppImage || true
        if [ ! -f HydraCAD-${VERSION}-x86_64.AppImage ]; then
          # Try without version in filename
          ./appimagetool AppDir HydraCAD-x86_64.AppImage
        fi
    
    - name: Upload Linux AppImage
      uses: actions/upload-artifact@v4
      with:
        name: HydraCAD-Linux-Installer
        path: HydraCAD-*.AppImage
        retention-days: 7

  build-macos:
    runs-on: macos-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Dependencies
      run: |
        brew install cmake qt@6 create-dmg
    
    - name: Extract Version
      id: version
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          version="${{ github.ref_name }}"
        else
          version="${{ github.event.inputs.version }}"
        fi
        version=$(echo "$version" | sed 's/^v//')
        if [ -z "$version" ]; then
          version="2.0.0"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
        echo "Release version: $version"
    
    - name: Configure CMake
      run: |
        # Try Apple Silicon first, then Intel
        if [ -d "/opt/homebrew/opt/qt@6/lib/cmake/Qt6" ]; then
          Qt6_DIR="/opt/homebrew/opt/qt@6/lib/cmake/Qt6"
        elif [ -d "/usr/local/opt/qt@6/lib/cmake/Qt6" ]; then
          Qt6_DIR="/usr/local/opt/qt@6/lib/cmake/Qt6"
        else
          # Try to find Qt6 via brew
          Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6
        fi
        echo "Using Qt6_DIR: $Qt6_DIR"
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCAD_USE_QT=ON -DCAD_BUILD_TESTS=OFF \
          -DQt6_DIR="$Qt6_DIR" -DCMAKE_PREFIX_PATH="$Qt6_DIR"
    
    - name: Build Application
      run: |
        cmake --build build --parallel
    
    - name: Create App Bundle
      run: |
        mkdir -p "Hydra CAD.app/Contents/MacOS"
        mkdir -p "Hydra CAD.app/Contents/Resources"
        cp build/cad_desktop "Hydra CAD.app/Contents/MacOS/Hydra CAD"
        chmod +x "Hydra CAD.app/Contents/MacOS/Hydra CAD"
        
        # Create Info.plist
        cat > "Hydra CAD.app/Contents/Info.plist" << 'EOF'
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
          <key>CFBundleExecutable</key>
          <string>Hydra CAD</string>
          <key>CFBundleIdentifier</key>
          <string>com.hydracad.app</string>
          <key>CFBundleName</key>
          <string>Hydra CAD</string>
          <key>CFBundleVersion</key>
          <string>${{ steps.version.outputs.version }}</string>
          <key>CFBundleShortVersionString</key>
          <string>${{ steps.version.outputs.version }}</string>
          <key>CFBundlePackageType</key>
          <string>APPL</string>
          <key>LSMinimumSystemVersion</key>
          <string>10.15</string>
        </dict>
        </plist>
        EOF
    
    - name: Deploy Qt Frameworks
      run: |
        # Determine Qt path (Apple Silicon or Intel)
        if [ -d "/opt/homebrew/opt/qt@6" ]; then
          QtPrefix="/opt/homebrew/opt/qt@6"
        elif [ -d "/usr/local/opt/qt@6" ]; then
          QtPrefix="/usr/local/opt/qt@6"
        else
          QtPrefix=$(brew --prefix qt@6)
        fi
        export PATH="$QtPrefix/bin:$PATH"
        echo "Using Qt prefix: $QtPrefix"
        
        if command -v macdeployqt &> /dev/null; then
          macdeployqt "Hydra CAD.app" -always-overwrite -verbose=2
        elif [ -f "$QtPrefix/bin/macdeployqt" ]; then
          "$QtPrefix/bin/macdeployqt" "Hydra CAD.app" -always-overwrite -verbose=2
        else
          echo "macdeployqt not found, trying to find Qt tools..."
          find "$QtPrefix" -name "macdeployqt" -type f 2>/dev/null | head -1 | xargs -I {} {} "Hydra CAD.app" -always-overwrite || echo "Qt deployment skipped"
        fi
    
    - name: Create DMG
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        if command -v create-dmg &> /dev/null; then
          create-dmg --volname "Hydra CAD" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --icon "Hydra CAD.app" 200 190 \
            --hide-extension "Hydra CAD.app" \
            --app-drop-link 600 185 \
            "HydraCAD-${VERSION}-macOS.dmg" \
            "Hydra CAD.app"
        else
          # Fallback: Use hdiutil
          hdiutil create -volname "Hydra CAD" -srcfolder "Hydra CAD.app" \
            -ov -format UDZO "HydraCAD-${VERSION}-macOS.dmg"
        fi
    
    - name: Upload macOS DMG
      uses: actions/upload-artifact@v4
      with:
        name: HydraCAD-macOS-Installer
        path: HydraCAD-*.dmg
        retention-days: 7

  create-release:
    needs: [build-windows, build-linux, build-macos]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Extract Version
      id: version
      run: |
        if [ "${{ github.ref_type }}" = "tag" ]; then
          version="${{ github.ref_name }}"
        else
          version="${{ github.event.inputs.version }}"
        fi
        version=$(echo "$version" | sed 's/^v//')
        if [ -z "$version" ]; then
          version="2.0.0"
        fi
        echo "version=$version" >> $GITHUB_OUTPUT
    
    - name: Download Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name != '' && github.ref_name || format('v{0}', github.event.inputs.version) }}
        name: Hydra CAD ${{ steps.version.outputs.version }}
        body: |
          ## ðŸš€ Hydra CAD ${{ steps.version.outputs.version }}
          
          ### ðŸ“¥ Installation
          
          **Windows:**
          1. Download `HydraCADSetup.exe`
          2. Doppelklick auf die Datei
          3. Installationsassistenten folgen
          
          **Linux:**
          1. Download `HydraCAD-*.AppImage`
          2. Datei ausfÃ¼hrbar machen: `chmod +x HydraCAD-*.AppImage`
          3. Doppelklick oder `./HydraCAD-*.AppImage` ausfÃ¼hren
          
          **macOS:**
          1. Download `HydraCAD-*-macOS.dmg`
          2. DMG Ã¶ffnen
          3. App in Applications-Ordner ziehen
          
          ### âœ¨ Features
          - âœ… VollstÃ¤ndige CAD-FunktionalitÃ¤t
          - âœ… Modern UI (Inventor-Style)
          - âœ… AI-Integration
          - âœ… Auto-Update System
          - âœ… Projekt-Management
          - âœ… User Authentication
          
          ### ðŸ’» Systemanforderungen
          - **Windows**: Windows 10/11 (64-bit)
          - **Linux**: Ubuntu 20.04+ / Debian 11+ / Fedora 34+
          - **macOS**: macOS 10.15+ (Intel/Apple Silicon)
          - **RAM**: 4 GB minimum, 8 GB empfohlen
          - **Festplatte**: 500 MB
          - **Grafik**: OpenGL 3.3+ kompatible Grafikkarte
          
          ### ðŸ“š Weitere Informationen
          - [CHANGELOG.md](CHANGELOG.md) - Ã„nderungsprotokoll
          - [docs/INSTALLATION.md](docs/INSTALLATION.md) - Installations-Anleitung
          - [docs/PROJECT_FINAL.md](docs/PROJECT_FINAL.md) - VollstÃ¤ndige Dokumentation
        files: |
          artifacts/HydraCAD-Windows-Installer/HydraCADSetup.exe
          artifacts/HydraCAD-Linux-Installer/*.AppImage
          artifacts/HydraCAD-macOS-Installer/*.dmg
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
