# Bei jedem veröffentlichten Release: Windows, Linux und macOS bauen und
# HydraCADSetup.exe, app-windows.zip, hydracad-linux-portable.tar.gz, HydraCAD-macos.zip ans Release hängen.
# Trigger: release: published ODER workflow_run (nach "Release bei Tag-Push erstellen") ODER manuell (workflow_dispatch).
# Falls am Release nur Source-Code steht: Actions → "Release – Assets anhängen" → Run workflow → tag_name eingeben.

name: Release – Assets anhängen

on:
  release:
    types: [published]
  workflow_run:
    workflows: ["Release bei Tag-Push erstellen"]
    types: [completed]
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag (z. B. v3.0.16) – nur bei manueller Ausführung'
        required: true
        default: 'v3.0.16'

jobs:
  build-windows:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: windows-latest
    env:
      WINDOWS_PFX_BASE64: ${{ secrets.WINDOWS_PFX_BASE64 }}
      WINDOWS_PFX_PASSWORD: ${{ secrets.WINDOWS_PFX_PASSWORD }}
    steps:
      - name: Tag ermitteln
        id: tag
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name || github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          fi
          echo "Using tag: ${{ steps.tag.outputs.tag }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      - name: Setup CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: '3.26'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - run: |
          Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python.exe" -ErrorAction SilentlyContinue
          Remove-Item "C:\Users\runneradmin\AppData\Local\Microsoft\WindowsApps\python3.exe" -ErrorAction SilentlyContinue
        shell: powershell

      - name: Setup Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          arch: 'win64_msvc2019_64'
          cache: true

      - name: Version aus Tag
        id: version
        shell: powershell
        run: |
          $tag = "${{ steps.tag.outputs.tag }}"
          $ver = $tag -replace '^v', ''
          if (-not $ver) { $ver = "3.0.14" }
          $parts = $ver.Split('.')
          $major = if ($parts.Length -gt 0) { $parts[0] } else { "3" }
          $minor = if ($parts.Length -gt 1) { $parts[1] } else { "0" }
          $patch = if ($parts.Length -gt 2) { $parts[2] } else { "0" }
          echo "version=$ver" >> $env:GITHUB_OUTPUT
          echo "vversion=v$ver" >> $env:GITHUB_OUTPUT
          echo "version_major=$major" >> $env:GITHUB_OUTPUT
          echo "version_minor=$minor" >> $env:GITHUB_OUTPUT
          echo "version_patch=$patch" >> $env:GITHUB_OUTPUT

      - run: |
          if (Test-Path build) { Remove-Item build -Recurse -Force }
        shell: powershell

      - run: choco install nsis -y
        continue-on-error: true

      - name: Configure CMake
        run: |
          $QtDir = $env:Qt6_DIR
          $appVer = "${{ steps.version.outputs.vversion }}"
          if (-not $appVer) { $appVer = "v3.0.14" }
          cmake -S . -B build -G "Visual Studio 17 2022" -A x64 `
            -DCAD_USE_QT=ON -DCAD_BUILD_TESTS=OFF -DCMAKE_BUILD_TYPE=Release `
            -DAPP_VERSION="$appVer" -DQt6_DIR="$QtDir" -DCMAKE_PREFIX_PATH="$QtDir"
        shell: powershell

      - run: cmake --build build --config Release --parallel
        shell: powershell

      - name: Verify EXE exists
        run: |
          if (-not (Test-Path "build\Release\cad_desktop.exe")) {
            Write-Error "cad_desktop.exe not found after build."
            exit 1
          }
        shell: powershell

      - name: windeployqt
        run: |
          if (-not $env:Qt6_DIR) {
            Write-Error "Qt6_DIR not set by install-qt-action."
            exit 1
          }
          $candidateBins = @(
            (Join-Path $env:Qt6_DIR "bin"),
            (Join-Path $env:Qt6_DIR "..\..\..\bin"),
            (Join-Path $env:Qt6_DIR "..\..\bin"),
            (Join-Path $env:Qt6_DIR "..\bin")
          )
          $qtBin = $candidateBins | Where-Object { Test-Path $_ } | Select-Object -First 1
          if (-not $qtBin) {
            Write-Error "Qt bin directory not found for Qt6_DIR=$env:Qt6_DIR"
            exit 1
          }
          $windeployqt = Join-Path $qtBin "windeployqt.exe"
          if (-not (Test-Path $windeployqt)) {
            Write-Error "windeployqt not found: $windeployqt"
            exit 1
          }
          & $windeployqt build\Release\cad_desktop.exe
          if ($LASTEXITCODE -ne 0) {
            Write-Error "windeployqt failed with exit code $LASTEXITCODE"
            exit 1
          }
          if (-not (Test-Path "build\Release\Qt6Gui.dll")) {
            Write-Error "Qt6Gui.dll not found after windeployqt. Packaging would be broken."
            exit 1
          }
        shell: powershell

      - name: NSIS Installer
        run: |
          $nsis = "C:\Program Files (x86)\NSIS\makensis.exe"
          if (-not (Test-Path $nsis)) { $nsis = "C:\Program Files\NSIS\makensis.exe" }
          if (-not (Test-Path $nsis)) {
            choco install nsis -y --no-progress
            Start-Sleep -Seconds 15
            $nsis = "C:\Program Files (x86)\NSIS\makensis.exe"
          }
          $ver = "${{ steps.version.outputs.version }}"
          $major = "${{ steps.version.outputs.version_major }}"
          $minor = "${{ steps.version.outputs.version_minor }}"
          $patch = "${{ steps.version.outputs.version_patch }}"
          & $nsis /DINSTALLER_VERSION="$ver" /DVERSION_MAJOR="$major" /DVERSION_MINOR="$minor" /DVERSION_PATCH="$patch" /DPROJECT_ROOT="$PWD" installer\hydracad.nsi
          if ($LASTEXITCODE -ne 0) {
            Write-Error "NSIS build failed with exit code $LASTEXITCODE"
            exit 1
          }
        shell: powershell

      - name: Verify Installer
        run: |
          if (-not (Test-Path "installer\HydraCADSetup.exe")) {
            Write-Error "HydraCADSetup.exe not found after NSIS build."
            exit 1
          }
          (Get-Item "installer\HydraCADSetup.exe").Length
        shell: powershell

      - name: Code Sign (optional)
        if: ${{ env.WINDOWS_PFX_BASE64 != '' }}
        env:
          WINDOWS_PFX_BASE64: ${{ env.WINDOWS_PFX_BASE64 }}
          WINDOWS_PFX_PASSWORD: ${{ env.WINDOWS_PFX_PASSWORD }}
        run: |
          $pfx = "$env:RUNNER_TEMP\codesign.pfx"
          [IO.File]::WriteAllBytes($pfx, [Convert]::FromBase64String($env:WINDOWS_PFX_BASE64))
          $signtool = Get-ChildItem "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter signtool.exe | Select-Object -First 1
          & $signtool.FullName sign /f $pfx /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 "build\Release\cad_desktop.exe"
          & $signtool.FullName sign /f $pfx /p $env:WINDOWS_PFX_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 "installer\HydraCADSetup.exe"
        shell: powershell

      - name: Portable ZIP
        run: |
          Compress-Archive -Path "build\Release\*" -DestinationPath app-windows.zip -Force
        shell: powershell

      - uses: actions/upload-artifact@v4
        with:
          name: release-windows-installer
          path: installer/
      - uses: actions/upload-artifact@v4
        with:
          name: release-windows-portable
          path: app-windows.zip

  build-linux:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: ubuntu-latest
    steps:
      - name: Tag ermitteln
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name || github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      - run: |
          sudo apt-get update
          sudo apt-get install -y build-essential cmake qt6-base-dev qt6-tools-dev qt6-tools-dev-tools libxcb-cursor0 libgl1-mesa-dev libxkbcommon-dev
        name: Install deps

      - name: Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCAD_USE_QT=ON -DCAD_BUILD_TESTS=OFF
          cmake --build build -j$(nproc)

      - name: Portable Tarball
        run: |
          mkdir -p hydracad-linux-portable/usr/bin
          cp build/cad_desktop hydracad-linux-portable/usr/bin/
          cp packaging/linux/HydraCAD.desktop packaging/linux/HydraCAD.png hydracad-linux-portable/
          ( echo '#!/bin/sh'; echo 'SELF="$(dirname "$0")"'; echo 'for d in /usr/lib/x86_64-linux-gnu /usr/lib64 /usr/lib; do [ -d "$d" ] && export LD_LIBRARY_PATH="${LD_LIBRARY_PATH:+$LD_LIBRARY_PATH:}$d"; done'; echo 'exec "$SELF/usr/bin/cad_desktop" "$@"' ) > hydracad-linux-portable/run.sh
          chmod +x hydracad-linux-portable/run.sh
          echo "Hydra CAD – Portable Linux. Voraussetzung: Qt6 (qt6-base / libqt6) installieren. Start: ./run.sh" > hydracad-linux-portable/README.txt
          tar czvf hydracad-linux-portable.tar.gz -C hydracad-linux-portable .

      - uses: actions/upload-artifact@v4
        with:
          name: release-linux-portable
          path: hydracad-linux-portable.tar.gz

  build-macos:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    runs-on: macos-14
    steps:
      - name: Tag ermitteln
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            TAG=$(gh release list --limit 1 --json tagName -q '.[0].tagName')
            echo "tag=$TAG" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.event.release.tag_name || github.event.inputs.tag_name }}" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}

      - name: Install Qt 6
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.5.3'
          # cache: false auf macOS, um "Cache service 400" / "Failed to save" zu vermeiden
          cache: false

      - name: Create .icns from PNG
        run: |
          mkdir -p packaging/macos/HydraCAD.icns.iconset
          for s in 16 32 64 128 256; do
            sips -z $s $s packaging/macos/HydraCAD.png --out packaging/macos/HydraCAD.icns.iconset/icon_${s}x${s}.png
            s2=$((s*2))
            sips -z $s2 $s2 packaging/macos/HydraCAD.png --out packaging/macos/HydraCAD.icns.iconset/icon_${s}x${s}@2x.png
          done
          iconutil -c icns packaging/macos/HydraCAD.icns.iconset -o packaging/macos/HydraCAD.icns
          rm -rf packaging/macos/HydraCAD.icns.iconset

      - name: Build
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCAD_USE_QT=ON -DCAD_BUILD_TESTS=OFF
          cmake --build build -j$(sysctl -n hw.ncpu)

      - name: Deploy Qt (macdeployqt)
        run: |
          MACDEPLOYQT=$(find $HOME/Qt -name macdeployqt -type f 2>/dev/null | head -1)
          if [ -n "$MACDEPLOYQT" ]; then
            QT_BIN=$(dirname "$MACDEPLOYQT")
            export PATH="$QT_BIN:$PATH"
          fi
          macdeployqt build/cad_desktop.app -always-overwrite || true

      - name: Create macOS archive
        run: |
          cd build && zip -r ../HydraCAD-macos.zip cad_desktop.app && cd ..

      - uses: actions/upload-artifact@v4
        with:
          name: release-macos
          path: HydraCAD-macos.zip

  # Nur Windows + Linux erforderlich – EXE/ZIP/Tarball werden so auch bei macOS-Fehler angehängt
  upload-release-assets:
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Tag ermitteln
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_run" ]; then
            TAG=$(gh release view --json tagName -q .tagName 2>/dev/null || gh release list --limit 1 --json tagName -q '.[0].tagName' 2>/dev/null)
          else
            TAG="${{ github.event.release.tag_name || github.event.inputs.tag_name }}"
          fi
          if [ -z "$TAG" ]; then
            echo "::error::Could not determine release tag."
            exit 1
          fi
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "Using tag: $TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Repository auschecken (für gh release upload)
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.tag.outputs.tag }}
          fetch-depth: 0

      - name: Artifacts für Release sammeln
        uses: actions/download-artifact@v4
        with:
          path: release-assets

      - name: Dateien für Upload vorbereiten
        run: |
          mkdir -p upload
          echo "=== Artifact-Struktur ==="
          find release-assets -type f
          # Artifact-Struktur: path "installer/HydraCADSetup.exe" → je nach Runner
          # release-windows-installer/HydraCADSetup.exe oder .../installer/HydraCADSetup.exe
          ( cp release-assets/release-windows-installer/HydraCADSetup.exe upload/ 2>/dev/null || \
            cp release-assets/release-windows-installer/installer/HydraCADSetup.exe upload/ 2>/dev/null ) || true
          cp release-assets/release-windows-portable/app-windows.zip upload/ 2>/dev/null || find release-assets -name 'app-windows.zip' -exec cp {} upload/ \; || true
          cp release-assets/release-linux-portable/hydracad-linux-portable.tar.gz upload/ 2>/dev/null || find release-assets -name 'hydracad-linux-portable.tar.gz' -exec cp {} upload/ \; || true
          cp release-assets/release-macos/HydraCAD-macos.zip upload/ 2>/dev/null || find release-assets -name 'HydraCAD-macos.zip' -exec cp {} upload/ \; || true
          # Garantiert EXE im Upload: find-Fallback (wichtig für Release-Seite)
          find release-assets -name 'HydraCADSetup.exe' -exec cp {} upload/ \;
          echo "=== Upload-Ordner (vor Prüfung) ==="
          ls -la upload/
          if [ ! -f upload/HydraCADSetup.exe ]; then
            echo "::error::HydraCADSetup.exe missing – Windows build/installer failed or wrong artifact path."
            exit 1
          fi
          if [ ! -f upload/hydracad-linux-portable.tar.gz ]; then
            echo "::error::hydracad-linux-portable.tar.gz missing – Linux build failed."
            exit 1
          fi

      - name: Checksums und update.json erzeugen
        id: checksums
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${REPO}/releases/download/${TAG}"
          NOTES_URL="https://github.com/${REPO}/releases/tag/${TAG}"
          echo "version=$TAG" >> $GITHUB_OUTPUT
          echo "notes_url=${NOTES_URL}" >> $GITHUB_OUTPUT
          echo '{"version":"'$TAG'","notes_url":"'$NOTES_URL'","assets":[' > upload/update.json
          first=1
          for f in upload/HydraCADSetup.exe upload/app-windows.zip upload/hydracad-linux-portable.tar.gz upload/HydraCAD-macos.zip; do
            if [ -f "$f" ]; then
              name=$(basename "$f")
              size=$(stat -c%s "$f" 2>/dev/null || stat -f%z "$f" 2>/dev/null)
              sha=$(sha256sum "$f" 2>/dev/null | awk '{print $1}' || shasum -a 256 "$f" 2>/dev/null | awk '{print $1}')
              [ -z "$sha" ] && sha=""
              [ $first -eq 0 ] && echo -n "," >> upload/update.json
              echo -n '{"name":"'$name'","url":"'$BASE_URL/$name'","size":'$size',"sha256":"'$sha'"}' >> upload/update.json
              first=0
            fi
          done
          echo "]}" >> upload/update.json
          echo "=== update.json ==="
          cat upload/update.json
          echo ""
          echo "=== SHA256SUMS.txt ==="
          (cd upload && for f in HydraCADSetup.exe app-windows.zip hydracad-linux-portable.tar.gz HydraCAD-macos.zip; do [ -f "$f" ] && sha256sum "$f" 2>/dev/null || shasum -a 256 "$f" 2>/dev/null; done) > upload/SHA256SUMS.txt
          cat upload/SHA256SUMS.txt

      - name: Assets ans Release hängen
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          if [ -z "$TAG" ]; then
            echo "::error::Release tag is empty. Set tag_name when running manually."
            exit 1
          fi
          echo "Uploading assets for tag: $TAG"
          for f in upload/HydraCADSetup.exe upload/app-windows.zip upload/hydracad-linux-portable.tar.gz upload/HydraCAD-macos.zip upload/update.json upload/SHA256SUMS.txt; do
            if [ -f "$f" ]; then
              echo "  -> $f"
              gh release upload "$TAG" "$f" --clobber
            fi
          done
          echo "Done. Assets at: https://github.com/${{ github.repository }}/releases/expanded_assets/$TAG"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release-Assets prüfen (EXE muss sichtbar sein)
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          echo "=== Assets auf dem Release $TAG ==="
          gh release view "$TAG" --json assets -q '.assets[] | "\(.name) (\(.size) bytes)"' || true
          if ! gh release view "$TAG" --json assets -q '.assets[] | select(.name == "HydraCADSetup.exe") | .name' 2>/dev/null | grep -q HydraCADSetup.exe; then
            echo "::warning::HydraCADSetup.exe ist nicht unter den Release-Assets – bitte Log prüfen."
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
